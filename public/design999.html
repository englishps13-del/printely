<!doctypehtml><html class=theme-sage lang=en><meta charset=UTF-8><title>The Artisan Planner with Ribbon Editor</title><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css2?family=Lora:wght@500&family=Poppins:wght@400;500;600&display=swap"rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Inter:wght@400;700&display=swap"rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css rel=stylesheet><style>:root{--font-body:'Poppins',sans-serif;--font-heading:'Lora',serif}html.theme-sage{--bg-main:#f9f8f6;--bg-paper:#ffffff;--text-primary:#3d4852;--text-secondary:#718096;--border-color:#e2e4e4;--accent-primary:#5A7D7C;--accent-light:#f0f3f3}html.theme-doodle{--bg-main:#f3f0f9;--bg-paper:#ffffff;--text-primary:#2d3748;--text-secondary:#6c567b;--border-color:#d3c3e1;--accent-primary:#8e44ad;--accent-light:#f4eff9}html.theme-sunset{--bg-main:#fff8f5;--bg-paper:#ffffff;--text-primary:#4a4a4a;--text-secondary:#b58d7a;--border-color:#f3e2e2;--accent-primary:#d95c5c;--accent-light:#fdedef}html.theme-ocean{--bg-main:#e8f4f8;--bg-paper:#ffffff;--text-primary:#2c3e50;--text-secondary:#5d6d7e;--border-color:#d1e1e9;--accent-primary:#3498db;--accent-light:#d6eaf8}html.theme-forest{--bg-main:#f0f4ec;--bg-paper:#ffffff;--text-primary:#4a5446;--text-secondary:#74886f;--border-color:#d8e2d4;--accent-primary:#5c845d;--accent-light:#e6f0e6}html.theme-midnight{--bg-main:#1c2331;--bg-paper:#2b3445;--text-primary:#eaf1f8;--text-secondary:#a4b3c4;--border-color:#3b4559;--accent-primary:#e0ac1a;--accent-light:#3d4a60}html.theme-berry{--bg-main:#fbf5f7;--bg-paper:#ffffff;--text-primary:#452a42;--text-secondary:#8c5b8b;--border-color:#e5d7df;--accent-primary:#c2527f;--accent-light:#fbebf1}html.theme-mono{--bg-main:#f4f4f6;--bg-paper:#ffffff;--text-primary:#333333;--text-secondary:#888888;--border-color:#dddddd;--accent-primary:#4a4a4a;--accent-light:#eeeeee}html.theme-lavender{--bg-main:#f9f5fb;--bg-paper:#ffffff;--text-primary:#3a2e40;--text-secondary:#6e5e7e;--border-color:#e8ddeb;--accent-primary:#9b72a8;--accent-light:#f1eaf2}html.theme-charcoal{--bg-main:#2f3640;--bg-paper:#3b4754;--text-primary:#e0e6eb;--text-secondary:#aab4be;--border-color:#4b5a68;--accent-primary:#eb5e5e;--accent-light:#4c5b6a}html.theme-mint{--bg-main:#f3f9f7;--bg-paper:#ffffff;--text-primary:#31423c;--text-secondary:#6b887d;--border-color:#d1e8e0;--accent-primary:#52b788;--accent-light:#d6f0e7}html.theme-coral{--bg-main:#fffaf7;--bg-paper:#ffffff;--text-primary:#4a423f;--text-secondary:#8b7d78;--border-color:#f7e6df;--accent-primary:#e58d7c;--accent-light:#f8e9e4}html.theme-tangerine{--bg-main:#fff7ec;--bg-paper:#ffffff;--text-primary:#4d443b;--text-secondary:#a27e57;--border-color:#f3e6d8;--accent-primary:#e88d3e;--accent-light:#fef1e5}html.theme-ocean-mint{--bg-main:#f5fbf6;--bg-paper:#ffffff;--text-primary:#58416d;--text-secondary:#92849c;--border-color:#d8e5db;--accent-primary:#94d3a8;--accent-light:#eaf1ed}html.theme-coral-aqua{--bg-main:#fbf7f6;--bg-paper:#ffffff;--text-primary:#4a423f;--text-secondary:#8b7d78;--border-color:#f7e6df;--accent-primary:#79c9c9;--accent-light:#e0f6f6}html.theme-gold-rush{--bg-main:#f8f8f4;--bg-paper:#ffffff;--text-primary:#2d3a4d;--text-secondary:#5e7390;--border-color:#dcdccf;--accent-primary:#f2c759;--accent-light:#f7f7e9}html.theme-forest-fire{--bg-main:#f0f4ec;--bg-paper:#ffffff;--text-primary:#4a5446;--text-secondary:#74886f;--border-color:#d8e2d4;--accent-primary:#d9534f;--accent-light:#fbe6e5}html.theme-plum-sunset{--bg-main:#f5f0f7;--bg-paper:#ffffff;--text-primary:#4c3c55;--text-secondary:#887494;--border-color:#e3d2e9;--accent-primary:#f28a7e;--accent-light:#f9e8e7}html.theme-ocean-dusk{--bg-main:#f0f3f6;--bg-paper:#ffffff;--text-primary:#2c3e50;--text-secondary:#5d6d7e;--border-color:#d1e1e9;--accent-primary:#4d82b3;--accent-light:#e4ebf0}html.theme-mint-chocolate{--bg-main:#f9f8f5;--bg-paper:#ffffff;--text-primary:#4a4a4a;--text-secondary:#8b8981;--border-color:#e6e3df;--accent-primary:#6c9a7d;--accent-light:#e6f0e6}html.theme-cherry-blossom{--bg-main:#fdf6f7;--bg-paper:#ffffff;--text-primary:#5c444a;--text-secondary:#8e747b;--border-color:#f1dfe3;--accent-primary:#e67390;--accent-light:#fbe7ec}html.theme-stone-sage{--bg-main:#f4f5f2;--bg-paper:#ffffff;--text-primary:#4b4b4b;--text-secondary:#8d9189;--border-color:#e2e4e4;--accent-primary:#5a7d7c;--accent-light:#f0f3f3}html.theme-tangerine-dream{--bg-main:#fff7ec;--bg-paper:#ffffff;--text-primary:#4d443b;--text-secondary:#a27e57;--border-color:#f3e6d8;--accent-primary:#6cc1d5;--accent-light:#e5f1f3}*{box-sizing:border-box}body{font-family:var(--font-body);background-color:var(--bg-main);color:var(--text-primary);margin:0;padding:1.5rem}.planner-container{max-width:1200px;margin:auto;background-color:var(--bg-paper);border-radius:0;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.07);border:2px solid var(--accent-primary)}.main-header h1{font-family:var(--font-heading);font-size:2.75rem;font-weight:500;margin:0 0 2rem 0;text-align:center}.grid-container{display:grid;gap:1.5rem}.three-col{grid-template-columns:repeat(3,1fr)}.two-col{grid-template-columns:repeat(2,1fr)}.block{padding:.001em 0;margin-bottom:.1rem}.block-header{display:flex;align-items:center;gap:.75rem;font-size:1.1rem;font-weight:600;margin:0 0 1.25rem 0;padding-bottom:.75rem;border-bottom:1px solid var(--border-color);color:var(--accent-primary)}.form-group label{display:block;font-size:.8rem;font-weight:500;margin-bottom:.35rem;color:var(--text-secondary)}input,select,textarea{width:100%;padding:.6rem .75rem;border:1px solid var(--border-color);border-radius:0;font-size:.9rem;background-color:var(--bg-main);color:var(--text-primary);font-family:var(--font-body);transition:border-color .2s,box-shadow .2s}input:focus,select:focus,textarea:focus{outline:0;border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-light)}textarea{resize:vertical;overflow-y:hidden;min-height:100px}.checkbox-group{display:flex;gap:1.5rem;flex-wrap:wrap;align-items:center}.checkbox-group label{display:flex;align-items:center;gap:.5rem;font-size:.9rem;margin-bottom:0}.checkbox-group input{accent-color:var(--accent-primary);width:auto}.procedure-table{width:100%;border-collapse:collapse}.procedure-table td,.procedure-table th{text-align:left;padding:0;vertical-align:top}.procedure-table th{font-size:.8rem;color:var(--text-secondary);padding-bottom:.5rem;font-weight:500}.procedure-table td{padding-right:.75rem}.procedure-table td:last-child{padding-right:0}.procedure-table .col-procedure{width:75%}.procedure-table .col-interaction{width:15%}.procedure-table .col-time{width:10%}.controls{position:sticky;top:0;z-index:999;display:flex;justify-content:flex-end;gap:.75rem;background:var(--bg-paper);padding:.6rem 1rem;border-bottom:2px solid var(--accent-primary);margin-bottom:1rem}.controls button,.controls select{background-color:var(--accent-primary);color:#fff;border:1px solid var(--accent-primary);border-radius:0;padding:.45rem 1rem;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s ease-in-out;display:flex;align-items:center;gap:.4rem}.controls button:hover{opacity:.8;transform:translateY(-2px)}.controls button i{font-size:.9rem}.ribbon{display:flex;flex-wrap:wrap;gap:8px;align-items:stretch;background:var(--bg-main);border:2px solid var(--accent-primary);border-radius:0;padding:10px;margin-bottom:24px}.group{display:flex;align-items:center;gap:6px;padding:6px;border:1px solid var(--border-color);border-radius:0;background:var(--bg-paper)}.group .label{font-size:12px;color:var(--text-secondary);margin-left:4px;white-space:nowrap}.ribbon .btn,.ribbon .btn-square,.ribbon input[type=color],.ribbon select{appearance:none;border:1px solid var(--border-color);background:var(--bg-main);padding:7px 10px;border-radius:0;font-size:14px;line-height:1;cursor:pointer;color:var(--text-primary)}.ribbon .btn,.ribbon .btn-square{display:inline-flex;align-items:center;justify-content:center;gap:6px}.ribbon .btn-square{width:36px;height:36px;padding:0}.ribbon .btn-square:hover,.ribbon .btn:hover,.ribbon select:hover{background-color:var(--accent-light)}.ribbon .btn-square.active,.ribbon .btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary)}.ribbon .sep{width:1px;background:var(--border-color);margin:0 6px;align-self:stretch}.ribbon .grow{flex:1 1 auto}.ribbon .pill{font-size:12px;padding:4px 8px;border-radius:0;border:1px solid var(--border-color);background:var(--bg-paper);color:var(--text-secondary)}[title]{position:relative}.editable-area{width:100%;padding:.6rem .75rem;border:1px solid var(--border-color);border-radius:0;font-size:.9rem;background-color:var(--bg-main);color:var(--text-primary);font-family:var(--font-body);transition:border-color .2s,box-shadow .2s;min-height:20px;overflow-y:auto;line-height:1.5}.editable-area.single-line{min-height:auto;height:38px;overflow:hidden;white-space:nowrap}.editable-area.single-line br{display:none}.editable-area.single-line *{display:inline}.editable-area:focus{outline:0;border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-light)}.editable-area[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--text-secondary);pointer-events:none}.editable-area.fixed-height{min-height:calc(1.5em * 23);max-height:calc(1.5em * 23)}@media print{@page{size:A4;margin:0}body,html{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;width:210mm;height:auto;margin:0;padding:0;background:var(--bg-main)}body{padding:0;box-sizing:border-box}.planner-container{width:1200px;margin:0 auto;box-shadow:none;border:none}.controls,.ribbon{display:none!important}}.controls button i{font-size:.9rem}.modal{display:none;position:fixed;z-index:3000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)}.modal-content{background-color:var(--bg-paper);margin:15% auto;padding:20px;border:1px solid var(--accent-primary);border-radius:8px;width:80%;max-width:500px;box-shadow:0 4px 8px rgba(0,0,0,.2)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:10px}.modal-header h2{margin:0;color:var(--text-primary)}.close{color:var(--text-secondary);font-size:28px;font-weight:700;cursor:pointer}.close:focus,.close:hover{color:var(--text-primary)}.modal-body{margin-bottom:15px}.modal-footer{display:flex;justify-content:flex-end;gap:10px}.modal-footer button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-weight:500}.btn-primary{background-color:var(--accent-primary);color:#fff}.btn-secondary{background-color:var(--bg-main);color:var(--text-primary);border:1px solid var(--border-color)}.btn-primary:hover{opacity:.9}.btn-secondary:hover{background-color:var(--border-color)}.toast{visibility:hidden;min-width:250px;margin-left:-125px;background-color:var(--accent-primary);color:#fff;text-align:center;border-radius:4px;padding:16px;position:fixed;z-index:4000;left:50%;bottom:30px}.toast.show{visibility:visible;animation:fadein .5s,fadeout .5s 2.5s}@keyframes fadein{from{bottom:0;opacity:0}to{bottom:30px;opacity:1}}@keyframes fadeout{from{bottom:30px;opacity:1}to{bottom:0;opacity:0}}.editable-area img,[contenteditable=true] img{width:100px!important;height:100px!important;object-fit:contain;display:inline-block;vertical-align:middle;margin:4px}select{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:none;padding-right:1.5rem}.form-group::after{font-weight:900;position:absolute;right:1.5rem;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text-secondary);font-size:.8rem}.form-group{position:relative}</style><div class=controls><select id=theme-selector><option value=theme-sage>Artisan Sage<option value=theme-doodle>Doodle Pad<option value=theme-sunset>Sunset<option value=theme-ocean>Ocean Breeze<option value=theme-forest>Forest Floor<option value=theme-berry>Berry Blast<option value=theme-mono>Monochrome<option value=theme-tangerine>Tangerine<option value=theme-lavender>Lavender Fields<option value=theme-mint>Mint Mojito<option value=theme-coral>Coral Reef<option value=theme-ocean-mint>Lavender Mint<option value=theme-coral-aqua>Coral Aqua<option value=theme-gold-rush>Gold Rush<option value=theme-forest-fire>Forest Fire<option value=theme-plum-sunset>Plum Sunset<option value=theme-ocean-dusk>Ocean Dusk<option value=theme-mint-chocolate>Mint Chocolate<option value=theme-cherry-blossom>Cherry Blossom<option value=theme-stone-sage>Stone & Sage<option value=theme-tangerine-dream>Tangerine Dream</select> <button id=print-btn><i class="fas fa-print"></i> Print</button> <button id=save-button><i class="fas fa-save"></i> Save</button> <a href=dashboard.html style=text-decoration:none><button type=button><i class="fas fa-tachometer-alt"></i> Dashboard</button></a></div><div class=planner-container><div class=ribbon id=ribbon><div class=group aria-label=Font><select id=fontFamily title="Font family"><option>Poppins<option>Lora<option>Inter<option>Arial<option>Helvetica<option>Times New Roman<option>Georgia<option>Garamond<option>Cambria<option>Calibri<option>Verdana<option>Tahoma<option>Trebuchet MS<option>Courier New<option>Consolas<option>Lucida Sans Unicode<option>Roboto<option>Open Sans<option>Montserrat<option>Impact<option>Comic Sans MS</select> <select id=fontSize title="Font size"><option value=10>10<option value=12>12<option value=14 selected>14<option value=16>16<option value=18>18<option value=20>20<option value=24>24<option value=28>28<option value=32>32<option value=40>40<option value=48>48</select> <button class=btn-square title="Decrease font size"id=fontDec>A-</button> <button class=btn-square title="Increase font size"id=fontInc>A+</button></div><div class=group aria-label=Emphasis><button class=btn-square title="Bold (Ctrl+B)"data-cmd=bold><b>B</b></button> <button class=btn-square title="Italic (Ctrl+I)"data-cmd=italic><i>I</i></button> <button class=btn-square title="Underline (Ctrl+U)"data-cmd=underline><u>U</u></button> <button class=btn-square title=Strikethrough data-cmd=strikeThrough><s>S</s></button> <button class=btn-square title=Superscript data-cmd=superscript>x<sup>2</sup></button> <button class=btn-square title=Subscript data-cmd=subscript>x<sub>2</sub></button></div><div class=group aria-label=Colors><label for=foreColor class=label>Text</label> <input id=foreColor type=color title="Text color"value=#3d4852> <span class=sep></span> <label for=hiliteColor class=label>Highlight</label> <input id=hiliteColor type=color title="Highlight color"value=#fff59d></div><div class=group aria-label=Paragraph><button class=btn-square title="Align Left"data-cmd=justifyLeft><i class="fa-solid fa-align-left"></i></button> <button class=btn-square title="Align Center"data-cmd=justifyCenter><i class="fa-solid fa-align-center"></i></button> <button class=btn-square title="Align Right"data-cmd=justifyRight><i class="fa-solid fa-align-right"></i></button> <button class=btn-square title=Justify data-cmd=justifyFull><i class="fa-solid fa-align-justify"></i></button> <span class=sep></span> <button class=btn-square title="Bullet list"data-cmd=insertUnorderedList><i class="fa-solid fa-list-ul"></i></button> <button class=btn-square title="Numbered list"data-cmd=insertOrderedList><i class="fa-solid fa-list-ol"></i></button> <button class=btn-square title=Outdent data-cmd=outdent><i class="fa-solid fa-outdent"></i></button> <button class=btn-square title=Indent data-cmd=indent><i class="fa-solid fa-indent"></i></button></div><div class=group aria-label=Actions><button class=btn title="Clear formatting (selection)"data-cmd=removeFormat><i class="fas fa-remove-format"></i> Clear</button></div><div class=group aria-label=Insert><button class="btn-square insert-image-btn"title="Insert Image"><i class="fa-solid fa-image"></i></button></div><div class=grow></div><div class=group><span class=pill id=wordCount>0 words</span> <span class=pill id=selectionInfo>No selection</span></div></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-clipboard-list"></i> Lesson Details</h2><div class="grid-container two-col"style=margin-bottom:1rem><div class=form-group><label for=school>Primary School</label><div class="editable-area single-line"id=school contenteditable=true></div></div><div class=form-group><label for=teacher>Teacher</label><div class="editable-area single-line"id=teacher contenteditable=true></div></div></div><div class="grid-container three-col"style=margin-bottom:1rem><div class=form-group><label for=date>Date</label><input id=date type=date></div><div class=form-group><label for=learners>Number of Learners</label><input id=learners type=number></div><div class=form-group><label for=level>Level</label><select id=levelSelect><option value="">Select Level<option value=3PS>3PS<option value=4PS>4PS<option value=5PS>5PS</select></div></div><div class=form-group style=margin-bottom:1rem><label for=sequence>Sequence</label><select id=sequenceSelect><option value="">Select Sequence</select></div><div class="grid-container two-col"><div class=form-group><label for=section>Section</label><select id=sectionSelect><option value="">Select Section</select></div><div class=form-group><label for=session>Session</label><select id=sessionSelect><option value="">Select Session</select></div></div></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-bullseye"></i> Learning Objectives</h2><div class=editable-area id=objectives-editor contenteditable=true data-placeholder="By the end of the lesson, learners will be able to..."></div></div><div class="grid-container two-col"style=margin-bottom:1rem><div class=block><h2 class=block-header><i class="fas fa-tasks"></i> Target Competencies</h2><div class=checkbox-group><label><input id=comp-interact type=checkbox> Interact</label><label><input id=comp-interpret type=checkbox> Interpret</label><label><input id=comp-produce type=checkbox> Produce</label></div></div><div class=block><h2 class=block-header><i class="fas fa-paperclip"></i> Teaching Materials</h2><div class=checkbox-group><label><input id=mat-textbook type=checkbox> Textbook</label> <label><input id=mat-wb type=checkbox> W.B</label> <label><input id=mat-flashcards type=checkbox> Flashcards</label> <label><input id=mat-song type=checkbox> Song</label> <label><input id=mat-slate type=checkbox> Slate</label></div></div></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-coffee"></i> Warmer</h2><table class=procedure-table><thead><tr><th class=col-procedure>Procedure<th class=col-interaction>Interaction<th class=col-time>Time<tbody><tr><td><div class="editable-area single-line"id=warmer-proc contenteditable=true></div><td><div class="editable-area single-line"id=warmer-interact contenteditable=true></div><td><div class="editable-area single-line"id=warmer-time contenteditable=true></div></table></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-chalkboard"></i> Install Resources</h2><table class=procedure-table><thead><tr><th class=col-procedure>Procedure<th class=col-interaction>Interaction<th class=col-time>Time<tbody><tr><td><div class="editable-area fixed-height"id=pres-proc contenteditable=true></div><td><div class="editable-area fixed-height"id=pres-interact contenteditable=true></div><td><div class="editable-area fixed-height"id=pres-time contenteditable=true></div></table></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-check-double"></i> Assessment</h2><table class=procedure-table><thead><tr><th class=col-procedure>Procedure<th class=col-interaction>Interaction<th class=col-time>Time<tbody><tr><td><div class="editable-area single-line"id=assess-proc contenteditable=true></div><td><div class="editable-area single-line"id=assess-interact contenteditable=true></div><td><div class="editable-area single-line"id=assess-time contenteditable=true></div></table></div><div class=block style=margin-bottom:1rem><h2 class=block-header><i class="fas fa-home"></i> Homework</h2><div class="grid-container three-col"><div class=form-group><label>Task / Instructions</label><div class=editable-area id=homework-task contenteditable=true style=min-height:40px></div></div><div class=form-group><label>Materials / Resources</label><div class=editable-area id=homework-materials contenteditable=true style=min-height:40px></div></div><div class=form-group><label>Due Date / Submission</label><div class=editable-area id=homework-due contenteditable=true style=min-height:40px></div></div></div></div></div><div class=modal id=saveModal><div class=modal-content><div class=modal-header><h2>Save Lesson Plan</h2><span class=close>×</span></div><div class=modal-body><div class=form-group><label for=planName>Lesson Plan Name</label> <input id=planName placeholder="Enter a name for your lesson plan"></div></div><div class=modal-footer><button class=btn-secondary id=cancelSave>Cancel</button> <button class=btn-primary id=confirmSave>Save</button></div></div></div><script type=module>// Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCVtWA2FqatlTRR1gSzCTNUSFYUAbAwLW0",
        authDomain: "printelydz.firebaseapp.com",
        projectId: "printelydz",
        storageBucket: "printelydz.appspot.com",
        messagingSenderId: "49201277305",
        appId: "1:49201277305:web:df932043e4d6d986cae7a8",
        measurementId: "G-R4VJL5SR88"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const saveButton = document.getElementById('save-button');
    const saveModal = document.getElementById('saveModal');
    const planNameInput = document.getElementById('planName');
    const cancelSaveBtn = document.getElementById('cancelSave');
    const confirmSaveBtn = document.getElementById('confirmSave');
    const closeModal = document.querySelector('.close');
    const toast = document.getElementById('toast');
    const themeSelector = document.getElementById('theme-selector');
    const printBtn = document.getElementById('print-btn');

    // Track current user
    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;

            const planIdToLoad = sessionStorage.getItem('planToLoadId');
            if (planIdToLoad) {
                loadLessonPlan(user.uid, planIdToLoad);
                sessionStorage.removeItem('planToLoadId');
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    // Function to load a lesson plan
    async function loadLessonPlan(userId, planId) {
        try {
            showLoading();
            const docRef = doc(db, "users", userId, "lessonPlans", planId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const planData = docSnap.data();

                document.getElementById('school').innerHTML = planData.school || '';
                document.getElementById('teacher').innerHTML = planData.teacher || '';
                document.getElementById('date').value = planData.date || '';
                document.getElementById('learners').value = planData.learners || '';
                document.getElementById('levelSelect').value = planData.level || '';
                document.getElementById('sequenceSelect').value = planData.sequence || '';
                document.getElementById('sectionSelect').value = planData.section || '';
                document.getElementById('sessionSelect').value = planData.session || '';
                document.getElementById('objectives-editor').innerHTML = planData.objectives || '';

                document.getElementById('comp-interact').checked = planData.competencies?.includes('Interact');
                document.getElementById('comp-interpret').checked = planData.competencies?.includes('Interpret');
                document.getElementById('comp-produce').checked = planData.competencies?.includes('Produce');

                document.getElementById('mat-textbook').checked = planData.materials?.includes('Textbook');
                document.getElementById('mat-wb').checked = planData.materials?.includes('W.B');
                document.getElementById('mat-flashcards').checked = planData.materials?.includes('Flashcards');
                document.getElementById('mat-song').checked = planData.materials?.includes('Song');
                document.getElementById('mat-slate').checked = planData.materials?.includes('Slate');
                
                if (planData.warmer) {
                    document.getElementById('warmer-proc').innerHTML = planData.warmer.procedure || '';
                    document.getElementById('warmer-interact').innerHTML = planData.warmer.interaction || '';
                    document.getElementById('warmer-time').innerHTML = planData.warmer.time || '';
                }

                if (planData.presentation) {
                    document.getElementById('pres-proc').innerHTML = planData.presentation.procedure || '';
                    document.getElementById('pres-interact').innerHTML = planData.presentation.interaction || '';
                    document.getElementById('pres-time').innerHTML = planData.presentation.time || '';
                }

                if (planData.assessment) {
                    document.getElementById('assess-proc').innerHTML = planData.assessment.procedure || '';
                    document.getElementById('assess-interact').innerHTML = planData.assessment.interaction || '';
                    document.getElementById('assess-time').innerHTML = planData.assessment.time || '';
                }

                if (planData.homework) {
                    document.getElementById('homework-task').innerHTML = planData.homework.task || '';
                    document.getElementById('homework-materials').innerHTML = planData.homework.materials || '';
                    document.getElementById('homework-due').innerHTML = planData.homework.due || '';
                }
                
                if (planData.theme) {
                    document.documentElement.className = planData.theme;
                    themeSelector.value = planData.theme;
                }

                showToast('Lesson plan loaded successfully!');
            } else {
                showToast('Lesson plan not found', 'error');
            }
        } catch (error) {
            console.error("Error loading lesson plan: ", error);
            showToast('Error loading lesson plan. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

        function showLoading() {
            if (!document.getElementById('loadingOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 5000;`;
                const spinner = document.createElement('div');
                spinner.style.cssText = `width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite;`;
                const keyframes = document.createElement('style');
                keyframes.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
                document.head.appendChild(keyframes);
                overlay.appendChild(spinner);
                document.body.appendChild(overlay);
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // Theme switcher
        themeSelector.addEventListener('change', function() {
            document.documentElement.className = this.value;
            localStorage.setItem('selectedTheme', this.value);
        });

        const savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme) {
            document.documentElement.className = savedTheme;
            themeSelector.value = savedTheme;
        }

        printBtn.addEventListener('click', function() {
            window.print();
        });

        saveButton.addEventListener('click', function() {
            if (!currentUser) {
                showToast('Please log in to save your lesson plan', 'error');
                return;
            }
            saveModal.style.display = 'block';
            planNameInput.focus();
        });

        closeModal.addEventListener('click', function() {
            saveModal.style.display = 'none';
            planNameInput.value = '';
        });

        cancelSaveBtn.addEventListener('click', function() {
            saveModal.style.display = 'none';
            planNameInput.value = '';
        });

        window.addEventListener('click', function(event) {
            if (event.target === saveModal) {
                saveModal.style.display = 'none';
                planNameInput.value = '';
            }
        });

        // Corrected SAVE FUNCTION
        confirmSaveBtn.addEventListener('click', async function() {
            const planName = planNameInput.value.trim();

            if (!planName) {
                showToast('Please enter a name for your lesson plan', 'error');
                return;
            }
            if (!currentUser) {
                showToast('You must be logged in to save', 'error');
                return;
            }
            
            showLoading();

            try {
                const lessonPlanData = {
                    planName: planName,
                    school: document.getElementById('school')?.innerHTML || '',
                    teacher: document.getElementById('teacher')?.innerHTML || '',
                    date: document.getElementById('date')?.value || '',
                    learners: document.getElementById('learners')?.value || '',
                    level: document.getElementById('levelSelect')?.value || '',
                    sequence: document.getElementById('sequenceSelect')?.value || '',
                    section: document.getElementById('sectionSelect')?.value || '',
                    session: document.getElementById('sessionSelect')?.value || '',
                    objectives: document.getElementById('objectives-editor')?.innerHTML || '',
                    competencies: [],
                    materials: [],
                    warmer: {
                        procedure: document.getElementById('warmer-proc')?.innerHTML || '',
                        interaction: document.getElementById('warmer-interact')?.innerHTML || '',
                        time: document.getElementById('warmer-time')?.innerHTML || ''
                    },
                    presentation: {
                        procedure: document.getElementById('pres-proc')?.innerHTML || '',
                        interaction: document.getElementById('pres-interact')?.innerHTML || '',
                        time: document.getElementById('pres-time')?.innerHTML || ''
                    },
                    assessment: {
                        procedure: document.getElementById('assess-proc')?.innerHTML || '',
                        interaction: document.getElementById('assess-interact')?.innerHTML || '',
                        time: document.getElementById('assess-time')?.innerHTML || ''
                    },
                    homework: {
                        task: document.getElementById('homework-task')?.innerHTML || '',
                        materials: document.getElementById('homework-materials')?.innerHTML || '',
                        due: document.getElementById('homework-due')?.innerHTML || ''
                    },
                    theme: themeSelector.value,
                    plannerType: 'artisan',
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                };

                if (document.getElementById('comp-interact')?.checked) lessonPlanData.competencies.push('Interact');
                if (document.getElementById('comp-interpret')?.checked) lessonPlanData.competencies.push('Interpret');
                if (document.getElementById('comp-produce')?.checked) lessonPlanData.competencies.push('Produce');

                if (document.getElementById('mat-textbook')?.checked) lessonPlanData.materials.push('Textbook');
                if (document.getElementById('mat-wb')?.checked) lessonPlanData.materials.push('W.B');
                if (document.getElementById('mat-flashcards')?.checked) lessonPlanData.materials.push('Flashcards');
                if (document.getElementById('mat-song')?.checked) lessonPlanData.materials.push('Song');
                if (document.getElementById('mat-slate')?.checked) lessonPlanData.materials.push('Slate');

                const plansRef = collection(db, "users", currentUser.uid, "lessonPlans");
                await addDoc(plansRef, lessonPlanData);

                saveModal.style.display = 'none';
                planNameInput.value = '';
                showToast('Lesson plan saved successfully!');
            } catch (error) {
                console.error("Error saving lesson plan: ", error);
                showToast('Error saving lesson plan: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Toast
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? '#d9534f' : 'var(--accent-primary)';
            toast.className = "toast show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Rich text commands
        document.querySelectorAll('.ribbon [data-cmd]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const cmd = this.dataset.cmd;
                if (cmd) {
                    document.execCommand(cmd, false, null);
                }
            });
        });
    /* --- IMAGE UPLOAD / INSERT (reusable) --- */
    (function () {
      // create one global hidden file input (re-used for all ribbons)
      let fileInput = document.getElementById('globalImageUploader');
      if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        fileInput.id = 'globalImageUploader';
        document.body.appendChild(fileInput);
      }

      function findEditor(button) {
        // 1) if button has data-editor or data-target, use that selector
        const selector = button && (button.dataset?.editor || button.dataset?.target);
        if (selector) {
          const el = document.querySelector(selector);
          if (el) return el;
        }

        // 2) if selection/caret inside editable, use that
        const sel = window.getSelection();
        if (sel && sel.rangeCount) {
          let node = sel.anchorNode;
          while (node) {
            if (node.nodeType === 1 && node.isContentEditable) return node;
            node = node.parentNode;
          }
        }

        // 3) if a contenteditable element is focused, use it
        const active = document.activeElement;
        if (active && active.isContentEditable) return active;

        // 4) try to find editable area within same ribbon as button
        if (button) {
          const ribbon = button.closest('.ribbon') || button.closest('[role="toolbar"]') || document;
          const maybe = ribbon.querySelector('[contenteditable="true"], .editable-area');
          if (maybe) return maybe;
        }

        // 5) fallback: first editable-area on page
        return document.querySelector('[contenteditable="true"], .editable-area');
      }

      // click handler for any inserted button (event delegation)
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('.insert-image-btn');
        if (!btn) return;
        e.preventDefault();

        const editor = findEditor(btn);
        if (!editor) {
          alert('No editable area found. Click inside the editor (to place caret) or give the button a data-editor selector.');
          return;
        }

        // remember which editor the upload should go into
        fileInput._targetEditor = editor;
        fileInput.click();
      });

      // when file chosen, read and insert
      fileInput.addEventListener('change', function () {
        const file = this.files && this.files[0];
        if (!file) {
          this.value = '';
          this._targetEditor = null;
          return;
        }

        const reader = new FileReader();
        const targetEditor = this._targetEditor || document.querySelector('[contenteditable="true"], .editable-area');

        reader.onload = function (ev) {
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.className = 'fixed-inserted-image';
          // inline styles are optional — CSS rule above should take precedence
          img.style.width = '100px';
          img.style.height = '100px';
          img.style.objectFit = 'contain';
          img.style.display = 'inline-block';
          img.style.verticalAlign = 'middle';
          img.style.margin = '4px';

          insertNodeAtCursor(img, targetEditor);
        };

        reader.readAsDataURL(file);

        // reset
        this.value = '';
        this._targetEditor = null;
      });

      function insertNodeAtCursor(node, editor) {
        editor.focus();
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) {
          // no selection: append and put caret after
          editor.appendChild(node);
          const r = document.createRange();
          r.setStartAfter(node);
          r.collapse(true);
          sel.removeAllRanges();
          sel.addRange(r);
          return;
        }

        let range = sel.getRangeAt(0);

        // ensure range is inside the editor; if not, append
        let container = range.commonAncestorContainer;
        while (container && container !== editor) container = container.parentNode;
        if (!container) {
          editor.appendChild(node);
          const r = document.createRange();
          r.setStartAfter(node);
          r.collapse(true);
          sel.removeAllRanges();
          sel.addRange(r);
          return;
        }

        // insert at current caret / selection
        range.deleteContents();
        range.insertNode(node);
        // move caret after inserted image
        range.setStartAfter(node);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    })();

    document.getElementById('fontFamily').addEventListener('change', function(e) {
        e.preventDefault();
        document.execCommand('fontName', false, this.value);
    });

    document.getElementById('fontSize').addEventListener('change', function(e) {
        e.preventDefault();
        const size = this.value;
        document.execCommand("fontSize", false, "1");
        const fontElements = document.getElementsByTagName("font");
        for (let i = 0, len = fontElements.length; i < len; ++i) {
            if (fontElements[i].size == "1") {
                fontElements[i].removeAttribute("size");
                fontElements[i].style.fontSize = size + "px";
            }
        }
    });

    document.getElementById('fontInc').addEventListener('click', function(e) { e.preventDefault(); document.execCommand('increaseFontSize', false); });
    document.getElementById('fontDec').addEventListener('click', function(e) { e.preventDefault(); document.execCommand('decreaseFontSize', false); });

    document.getElementById('foreColor').addEventListener('input', function(e) {
        e.preventDefault();
        document.execCommand('foreColor', false, this.value);
    });

    document.getElementById('hiliteColor').addEventListener('input', function(e) {
        e.preventDefault();
        document.execCommand('hiliteColor', false, this.value);
    });


    // Word counter
    function updateWordCount() {
        const editableAreas = document.querySelectorAll('.editable-area');
        let totalWords = 0;

        editableAreas.forEach(area => {
            const text = area.innerText || '';
            if(text.trim()){
               const words = text.trim().split(/\s+/).filter(word => word.length > 0);
               totalWords += words.length;
            }
        });
        document.getElementById('wordCount').textContent = totalWords + ' words';
    }
    
    document.querySelectorAll('.editable-area').forEach(area => {
        area.addEventListener('input', updateWordCount);
    });
    
    document.addEventListener('selectionchange', function() {
        const selection = window.getSelection();
        const selectionText = selection.toString().trim();
        if (selectionText) {
            document.getElementById('selectionInfo').textContent = selectionText.length + ' chars selected';
        } else {
            document.getElementById('selectionInfo').textContent = 'No selection';
        }
    });

    updateWordCount();
     // --- Curriculum Data ---
  const curriculum = { "3PS": { "Family and Friends": { "Family": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Friends": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "School": { "School Objects": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "School Subjects": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Home": { "Describing a House": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Location Rooms in a House": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Play Time": { "Toys": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Favourite Toys": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Pets": { "Pets": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Pets Body Parts": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Birthday": { "Party Invitation": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Party Celebration": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] } }, "4PS": { "Family and Friends": { "Family": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Friends": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] }, "School": { "School Facilities": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Mapping": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] },
  "Fun Time and Games": { "Fun Time": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Games": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] },
"Food and Health": { "Food": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Health": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] },
 "Animals": { "Farm": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Zoo": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] },

 }, "5PS": { "Jobs, Occupations, and Hobbies": { "Jobs and Occupations": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Hobbies": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] }, "Hometown, City, Village Amenities": { "Amenities": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Directions": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] }, "Holidays and Travelling": { "Holidays": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Travelling": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] } } };
// --- Dropdown Handlers ---
  const [levelSelect, sequenceSelect, sectionSelect, sessionSelect] = ["levelSelect", "sequenceSelect", "sectionSelect", "sessionSelect"].map(id => document.getElementById(id));
  levelSelect.addEventListener("change", () => {
    sequenceSelect.innerHTML = "<option value=''>Select Sequence</option>"; sectionSelect.innerHTML = "<option value=''>Select Section</option>"; sessionSelect.innerHTML = "<option value=''>Select Session</option>";
    if (curriculum[levelSelect.value]) {
      Object.keys(curriculum[levelSelect.value]).forEach(seq => sequenceSelect.add(new Option(seq, seq)));
      sequenceSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
    }
  });
  sequenceSelect.addEventListener("change", () => {
    sectionSelect.innerHTML = "<option value=''>Select Section</option>"; sessionSelect.innerHTML = "<option value=''>Select Session</option>";
    if (sequenceSelect.value === "Remediation & Standardisation") return sectionSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
    const seqData = curriculum[levelSelect.value]?.[sequenceSelect.value];
    if (seqData) Object.keys(seqData).forEach(sec => sectionSelect.add(new Option(sec, sec)));
  });
  sectionSelect.addEventListener("change", () => {
    sessionSelect.innerHTML = "<option value=''>Select Session</option>";
    if (sectionSelect.value === "Remediation & Standardisation") return sessionSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
    const sessData = curriculum[levelSelect.value]?.[sequenceSelect.value]?.[sectionSelect.value];
    if (sessData) sessData.forEach(ses => sessionSelect.add(new Option(ses, ses)));
  });</script>