<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lesson Plan Editor</title>
    <link rel="icon" type="image/x-icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

<style>
    :root { --accent-color: #2c3e99; }

    body {
        font-family: 'Poppins', 'Roboto', sans-serif;
        margin: 20px;
        background: #f4f4f9;
        font-size: 13px;
        transition: background 0.3s, color 0.3s;
        color: #333;
    }

    .lesson-plan-container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .plan-title {
        font-family: 'Dancing Script', cursive;
        font-size: 48px;
        text-align: left;
        margin: 0 0 20px 0;
        color: #000;
    }
    
    .auth-status {
        text-align: center; margin: -15px 0 15px 0;
        font-size: 12px; color: #666;
    }

    /* Box container styles */
    .box {
        border: 1.5px solid #ccc;
        border-radius: 8px;
        padding: 10px 12px 8px 12px; /* Reduced padding */
        margin-bottom: 15px;
        position: relative;
        background-color: #fff;
    }

    .box-label {
        position: absolute;
        top: -10px;
        left: 12px;
        background: #fff;
        padding: 0 8px;
        font-weight: 600;
        font-size: 12px;
        color: #555;
        letter-spacing: 0.5px;
        transition: color 0.3s;
    }

    /* Grid layout */
    .content-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }
    .grid-col-span-1 { grid-column: span 1; }
    .grid-col-span-2 { grid-column: span 2; }
    .grid-col-span-3 { grid-column: span 3; }
    .grid-col-span-4 { grid-column: span 4; }
    .content-grid .box { margin-bottom: 0; }
    
    /* Compact grid for top section */
    .compact-grid .box {
        padding: 6px 12px 4px 12px; /* Even more reduced padding */
    }
    .compact-grid .box-label {
        font-size: 11px; /* Smaller label */
    }
    
    /* Inputs & selects */
    input[type="text"], input[type="number"], select, textarea {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        font-family: inherit;
        font-size: 13px;
        padding: 2px; /* Reduced padding */
        box-sizing: border-box;
    }
    textarea {
        resize: none;
        overflow: hidden; 
    }
    select {
        appearance: none;
        padding-right: 20px;
        background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='8'><polyline points='1,1 6,6 11,1' stroke='%23333' stroke-width='2' fill='none' stroke-linecap='round'/></svg>") no-repeat right 5px center;
    }

    /* Checkboxes */
    .custom-checkbox { position: relative; cursor: pointer; display: inline-flex; align-items: center; }
    .custom-checkbox input { position: absolute; opacity: 0; }
    .custom-checkbox span { display: inline-block; height: 14px; width: 14px; border: 1.5px solid #000; border-radius: 3px; background-color: #fff; margin-right: 6px; position: relative; }
    .custom-checkbox input:checked ~ span { background-color: #000; }
    .custom-checkbox input:checked ~ span::after { content: ""; position: absolute; display: block; left: 3px; top: 0px; width: 4px; height: 8px; border: solid #fff; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .checkbox-inline { display: flex; flex-wrap: wrap; gap: 10px 20px; padding-top: 5px; }
    
    /* Rich Text Editor */
    .ribbon { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        background: #f9f9f9; 
        border: 1px solid #e0e0e0; 
        border-radius: 8px; 
        padding: 10px; 
        margin-bottom: 24px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .group { 
        display: flex; 
        align-items: center; 
        gap: 6px; 
        padding: 6px; 
        border: 1px solid #dcdcdc; 
        border-radius: 6px; 
        background: #fff;
        transition: all 0.2s ease;
    }
    .group:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    .ribbon select, .ribbon input[type="color"], .ribbon .btn, .ribbon .btn-square { 
        appearance: none; 
        border: 1px solid #dcdcdc; 
        background: #fff; 
        padding: 7px 10px; 
        border-radius: 5px; 
        font-size: 14px; 
        cursor: pointer; 
        color: #333; 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        gap: 6px;
        transition: all 0.2s ease;
    }
    .ribbon .btn-square { 
        width: 36px; 
        height: 36px; 
        padding: 0; 
    }
    .ribbon .btn.active, .ribbon .btn-square.active { 
        background: var(--accent-color); 
        color: #fff; 
        border-color: var(--accent-color); 
    }
    .ribbon select:disabled, .ribbon input[type="color"]:disabled, .ribbon .btn:disabled, .ribbon .btn-square:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .ribbon .btn:hover, .ribbon .btn-square:hover, .ribbon select:hover {
        background: #f0f0f0;
        border-color: #bbb;
    }
    .ribbon .btn:active, .ribbon .btn-square:active, .ribbon select:active {
        background: #e0e0e0;
        transform: translateY(1px);
    }
    .editable-area { 
        width: 100%; 
        border: none; 
        outline: none; 
        font-size: 13px; 
        line-height: 1.6; 
        min-height: 120px; 
        cursor: text; 
        resize: vertical; 
        padding: 5px; 
    }
    .editable-area:focus { 
        box-shadow: 0 0 0 2px var(--accent-color); 
        border-radius: 4px; 
    }
    .editable-area[data-placeholder]:empty::before { 
        content: attr(data-placeholder); 
        color: #999; 
        pointer-events: none; 
        font-style: italic; 
    }
    .editable-area img { 
        max-width: 100%; 
        height: auto; 
        object-fit: contain; 
        vertical-align: middle; 
    }

    /* Bottom Buttons */
    .bottom-buttons { 
        margin-top: 15px; 
        text-align: center; 
    }
    .bottom-buttons button, .bottom-buttons select { 
        background: transparent; 
        color: inherit; 
        border: 2px solid currentColor; 
        padding: 8px 14px; 
        margin: 6px; 
        border-radius: 5px; 
        cursor: pointer; 
        font-weight: 500; 
        transition: all 0.3s ease; 
    }
    .bottom-buttons button:hover {
        background: rgba(0,0,0,0.05);
        transform: translateY(-2px);
    }
    .bottom-buttons button:disabled { 
        border-color: #ccc; 
        color: #ccc; 
        cursor: not-allowed; 
    }

    /* Image upload styling */
    .image-upload-container {
        position: relative;
        display: inline-block;
    }
    .image-preview {
        position: absolute;
        top: 40px;
        left: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 100;
        display: none;
        max-width: 300px;
    }
    .image-preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .image-preview button {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
    }
    .image-preview button:hover {
        background: #1a2550;
    }

    /* ---------- THEMES ---------- */
    .box, th, td { transition: border-color 0.3s; }
    th { transition: background-color 0.3s, color 0.3s; }
    
    body.default-theme .box, body.default-theme th, body.default-theme td { border-color: #000; }
    body.default-theme th { background-color: #f3f3f3; color: #000; }
    body.default-theme .box-label { color: #000; }
    
    body.theme-blue { color: #2c3e99; }
    body.theme-blue .box, body.theme-blue th, body.theme-blue td, body.theme-blue .custom-checkbox input:checked ~ span { border-color: #2c3e99; }
    body.theme-blue th { background-color: #d6e3ff; }
    body.theme-blue .box-label { color: #2c3e99; }
    body.theme-blue .custom-checkbox input:checked ~ span { background-color: #2c3e99; }

    body.theme-green { color: #2d7a33; }
    body.theme-green .box, body.theme-green th, body.theme-green td, body.theme-green .custom-checkbox input:checked ~ span { border-color: #2d7a33; }
    body.theme-green th { background-color: #d9f5d9; }
    body.theme-green .box-label { color: #2d7a33; }
    body.theme-green .custom-checkbox input:checked ~ span { background-color: #2d7a33; }

    body.theme-yellow { color: #b39700; }
    body.theme-yellow .box, body.theme-yellow th, body.theme-yellow td, body.theme-yellow .custom-checkbox input:checked ~ span { border-color: #b39700; }
    body.theme-yellow th { background-color: #fff2cc; }
    body.theme-yellow .box-label { color: #b39700; }
    body.theme-yellow .custom-checkbox input:checked ~ span { background-color: #b39700; }

    body.theme-pink { color: #cc3366; }
    body.theme-pink .box, body.theme-pink th, body.theme-pink td, body.theme-pink .custom-checkbox input:checked ~ span { border-color: #cc3366; }
    body.theme-pink th { background-color: #ffd6e6; }
    body.theme-pink .box-label { color: #cc3366; }
    body.theme-pink .custom-checkbox input:checked ~ span { background-color: #cc3366; }

    body.theme-purple { color: #5e2d91; }
    body.theme-purple .box, body.theme-purple th, body.theme-purple td, body.theme-purple .custom-checkbox input:checked ~ span { border-color: #5e2d91; }
    body.theme-purple th { background-color: #e6d6ff; }
    body.theme-purple .box-label { color: #5e2d91; }
    body.theme-purple .custom-checkbox input:checked ~ span { background-color: #5e2d91; }

    body.theme-gray { color: #444; }
    body.theme-gray .box, body.theme-gray th, body.theme-gray td, body.theme-gray .custom-checkbox input:checked ~ span { border-color: #444; }
    body.theme-gray th { background-color: #dddddd; }
    body.theme-gray .box-label { color: #444; }
    body.theme-gray .custom-checkbox input:checked ~ span { background-color: #444; }

    /* ---------- PRINT STYLES ---------- */
    @media print {
        @page { size: A4; margin: 0; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
        body { 
            margin: 0 !important; 
            padding: 0 !important; 
            background: #fff !important; 
            font-size: 10px !important; /* Smaller font for print */
        }
        .lesson-plan-container {
            width: 210mm !important; 
            height: 297mm !important; 
            margin: 0 !important;
            padding: 6mm !important; /* Further reduced padding */
            box-shadow: none !important; 
            border: none !important;
            box-sizing: border-box !important; 
            overflow: hidden !important;
        }
        .box, th, td { 
            border: 1px solid #000 !important; 
            background: #fff !important; 
        }
        th { 
            background-color: #f0f0f0 !important; 
            color: #000 !important; 
        }
        input, select, textarea { 
            border: none !important; 
            padding: 0 !important; 
            width: 100% !important; 
            background: transparent !important; 
        }
        textarea { 
            overflow: visible !important; 
            height: auto !important; 
        }
        .no-print, .ribbon, .custom-select-print-view { 
            display: none !important; 
        }
        select.print-hidden { 
            display: none !important; 
        }
        .print-only-text { 
            display: block !important; /* Changed to block */
            font-size: 10px !important;
            color: #000 !important; /* Force black text in print */
            white-space: pre-wrap !important; /* Preserve line breaks and wrap text */
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            margin-top: 3px;
            line-height: 1.3;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* More space for install resources in print */
        #installResourcesProcedure {
            min-height: 200px !important; /* Increased height */
        }
        
        /* Smaller compact grid in print */
        .compact-grid .box {
            padding: 4px 8px 2px 8px !important;
        }
        .compact-grid .box-label {
            font-size: 9px !important;
        }
        
        /* Ensure theme colors are preserved in print */
        body.theme-blue .box, body.theme-blue th, body.theme-blue td { border-color: #2c3e99 !important; }
        body.theme-blue th { background-color: #d6e3ff !important; color: #2c3e99 !important; }
        
        body.theme-green .box, body.theme-green th, body.theme-green td { border-color: #2d7a33 !important; }
        body.theme-green th { background-color: #d9f5d9 !important; color: #2d7a33 !important; }
        
        body.theme-yellow .box, body.theme-yellow th, body.theme-yellow td { border-color: #b39700 !important; }
        body.theme-yellow th { background-color: #fff2cc !important; color: #b39700 !important; }
        
        body.theme-pink .box, body.theme-pink th, body.theme-pink td { border-color: #cc3366 !important; }
        body.theme-pink th { background-color: #ffd6e6 !important; color: #cc3366 !important; }
        
        body.theme-purple .box, body.theme-purple th, body.theme-purple td { border-color: #5e2d91 !important; }
        body.theme-purple th { background-color: #e6d6ff !important; color: #5e2d91 !important; }
        
        body.theme-gray .box, body.theme-gray th, body.theme-gray td { border-color: #444 !important; }
        body.theme-gray th { background-color: #dddddd !important; color: #444 !important; }
        
        /* Hide selects and show only text for target and cross-curricular */
        .target-competence-container select, .cross-curricular-container select {
            display: none !important;
        }
        /* Hide textareas in these containers for print to avoid duplication */
        .target-competence-container textarea, .cross-curricular-container textarea {
            display: none !important;
        }
        .target-competence-container .print-only-text, .cross-curricular-container .print-only-text {
            display: block !important;
            margin-top: 0;
            white-space: pre-wrap !important; /* Preserve line breaks */
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        /* Special handling for dropdowns in print */
        .dropdown-print-text {
            display: block !important;
            font-size: 10px !important;
            color: #000 !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            margin-top: 2px;
            line-height: 1.2;
        }
    }
    .print-only-text { display: none; }
    
    /* Custom table headers design */
    .custom-table-header {
        display: flex;
        margin-bottom: 10px;
        border-bottom: 1.5px solid #ccc;
        padding-bottom: 5px;
    }
    .custom-table-header div {
        font-weight: 600;
        font-size: 12px;
        color: #555;
        letter-spacing: 0.5px;
    }
    .custom-table-header .stages { width: 15%; }
    .custom-table-header .procedure { width: 55%; }
    .custom-table-header .interaction { width: 15%; }
    .custom-table-header .time { width: 15%; }
    
    /* Table row styling */
    .procedure-row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 1px dashed #ccc;
    }
    .procedure-row:last-child {
        border-bottom: none;
    }
    .procedure-row > div {
        padding: 5px;
    }
    .procedure-row .stages { width: 15%; font-weight: 500; }
    .procedure-row .procedure { width: 55%; }
    .procedure-row .interaction { width: 15%; }
    .procedure-row .time { width: 15%; }
    
    /* Self-reflection custom styling */
    .reflection-header {
        display: flex;
        margin-bottom: 10px;
        border-bottom: 1.5px solid #ccc;
        padding-bottom: 5px;
    }
    .reflection-header div {
        font-weight: 600;
        font-size: 12px;
        color: #555;
        letter-spacing: 0.5px;
    }
    .reflection-header .what-worked { width: 33.33%; }
    .reflection-header .what-hindered { width: 33.33%; }
    .reflection-header .action-points { width: 33.33%; }
    
    .reflection-row {
        display: flex;
        margin-bottom: 10px;
    }
    .reflection-row > div {
        padding: 5px;
        width: 33.33%;
    }
    
    /* Focusable text areas */
    .focusable {
        position: relative;
    }
    .focusable:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--accent-color);
        border-radius: 4px;
    }
    
    /* Target and Cross-curricular containers */
    .target-competence-container, .cross-curricular-container {
        position: relative;
    }
    /* Add some space between select and textarea */
    .target-competence-container select, .cross-curricular-container select {
        margin-bottom: 8px;
    }

    
    /* Dropdown text container */
    .dropdown-text-container {
        position: relative;
    }
</style>
</head>

<body class="default-theme">
    <input type="file" id="imageUpload" accept="image/*" style="display: none;">

    <div class="lesson-plan-container">
        <div id="authStatus" class="auth-status no-print">Checking login status...</div>

<!-- Ribbon Toolbar -->
<div id="ribbon-toolbar" class="ribbon no-print">
  <div class="group">
    <button type="button" class="btn-square" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
    <button type="button" class="btn-square" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
    <button type="button" class="btn-square" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
    <button type="button" class="btn-square" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
  </div>
  
  <div class="group">
    <button type="button" class="btn-square" data-command="justifyLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
    <button type="button" class="btn-square" data-command="justifyCenter" title="Align Center"><i class="fas fa-align-center"></i></button>
    <button type="button" class="btn-square" data-command="justifyRight" title="Align Right"><i class="fas fa-align-right"></i></button>
    <button type="button" class="btn-square" data-command="justifyFull" title="Justify"><i class="fas fa-align-justify"></i></button>
  </div>
  
  <div class="group">
    <button type="button" class="btn-square" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
    <button type="button" class="btn-square" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
  </div>
  
  <div class="group">
    <button type="button" class="btn-square" data-command="createLink" title="Insert Link"><i class="fas fa-link"></i></button>
    <button type="button" class="btn-square" data-command="unlink" title="Remove Link"><i class="fas fa-unlink"></i></button>
    <div class="image-upload-container">
      <button type="button" id="insertImageBtn" class="btn-square" title="Insert Image"><i class="fas fa-image"></i></button>
      <div class="image-preview" id="imagePreview">
        <img id="previewImg" src="" alt="Preview">
        <div>
          <button id="confirmImage">Insert</button>
          <button id="cancelImage">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="group">
    <select id="fontSize" title="Font Size">
      <option value="1">Small</option>
      <option value="3" selected>Normal</option>
      <option value="5">Large</option>
      <option value="7">Huge</option>
    </select>
    <input type="color" id="fontColor" title="Text Color" />
  </div>

  <div class="group">
    <button type="button" class="btn-square" data-command="undo" title="Undo"><i class="fas fa-undo"></i></button>
    <button type="button" class="btn-square" data-command="redo" title="Redo"><i class="fas fa-redo"></i></button>
  </div>
</div>


        <div class="content-grid compact-grid">
            <div class="box grid-col-span-2"><div class="box-label">PRIMARY SCHOOL</div><input type="text" id="schoolName" placeholder="Enter school name" class="focusable"></div>
            <div class="box grid-col-span-2"><div class="box-label">TEACHER</div><input type="text" id="teacherName" placeholder="Enter teacher name" class="focusable"></div>
            
            <div class="box grid-col-span-2 dropdown-text-container">
                <div class="box-label">LEVEL</div>
                <select id="levelSelect" class="dropdown-select">
                    <option value="">-- Select --</option>
                    <option value="3PS">3PS</option>
                    <option value="4PS">4PS</option>
                    <option value="5PS">5PS</option>
                </select>
                <span class="print-only-text dropdown-print-text"></span>
            </div>
            <div class="box grid-col-span-2"><div class="box-label"># OF LEARNERS</div><input type="number" id="learnerCount" placeholder="0" class="focusable"></div>

            <div class="box grid-col-span-2 dropdown-text-container">
                <div class="box-label">SEQUENCE</div>
                <select id="sequenceSelect" class="dropdown-select">
                    <option value="">-- Select --</option>
                </select>
                <span class="print-only-text dropdown-print-text"></span>
            </div>
            <div class="box grid-col-span-1 dropdown-text-container">
                <div class="box-label">SECTION</div>
                <select id="sectionSelect" class="dropdown-select">
                    <option value="">-- Select --</option>
                </select>
                <span class="print-only-text dropdown-print-text"></span>
            </div>
            <div class="box grid-col-span-1 dropdown-text-container">
                <div class="box-label">SESSION</div>
                <select id="sessionSelect" class="dropdown-select">
                    <option value="">-- Select --</option>
                </select>
                <span class="print-only-text dropdown-print-text"></span>
            </div>
            
            <div class="box grid-col-span-4"><div class="box-label">SESSION OBJECTIVE(S)</div><input type="text" id="sessionObjective" placeholder="By the end of the lesson, learners will be able to..." class="focusable"></div>
        </div>

        <div class="content-grid">
            <div class="box grid-col-span-3 target-competence-container">
                <div class="box-label">TARGET COMPETENCE</div>
                <select id="targetCompetenceSelect">
                    <option value="" selected disabled>-- Select an option --</option>
                    <option value="Comprehend oral messages and identify the meaning of words, expressions and sentences in a familiar context using paralinguistic features.">Comprehend oral messages and identify the meaning...</option>
                    <option value="Decode symbols, read simple messages of about 30–40 words and understand the meaning of words and structures using graphemic/phonemic knowledge, reading basics, and decoding strategies.">Decode symbols, read simple messages...</option>
                    <option value="Write letters, words, and simple sentences using correct handwriting and punctuation / Produce words using correct handwriting to fill in a form with specific details related to the learners' immediate environment, daily concern and interests.">Write letters, words, and simple sentences...</option>
                    <option value="Interact orally in communicative situations related to the learner's immediate environment, daily concern and interests using simple words, expressions and sentences.">Interact orally in communicative situations...</option>
                    <option value="Transfer notes into a message of about 10–20 words related to the learner's immediate environment using writing mechanics / Decode a short simple message of about 20–40 words and understand its meaning using reading skills.">Transfer notes into a message...</option>
                    <option value="Written Comprehension: Learners can decode a short, simple message of about 20 words and understand its meaning using reading skills.">Written Comprehension: Decode a short message...</option>
                    <option value="Oral Production: Learners can interact orally in communicative situations related to their immediate environment.">Oral Production: Interact orally...</option>
                    <option value="Oral Comprehension: Learners can interpret oral messages in communicative situations related to their immediate environment using paralinguistic features.">Oral Comprehension: Interpret oral messages...</option>
                    <option value="Written Production: Learners can transfer notes into a message of about 10 words related to their immediate environment using writing mechanics.">Written Production: Transfer notes into a message...</option>
                </select>
                <textarea id="targetCompetenceText" placeholder="Selected competence will appear here..." class="focusable" rows="1"></textarea>
                <span class="print-only-text"></span>
            </div>
            <div class="box grid-col-span-1">
                <div class="box-label">TEACHING MATERIALS</div>
                <div class="checkbox-inline" id="teachingMaterials">
                    <label class="custom-checkbox"><input type="checkbox" value="Textbook"><span></span> Textbook</label>
                    <label class="custom-checkbox"><input type="checkbox" value="W.B"><span></span> W.B</label>
                    <label class="custom-checkbox"><input type="checkbox" value="Flashcards"><span></span> Flashcards</label>
                    <label class="custom-checkbox"><input type="checkbox" value="Song"><span></span> Song</label>
                </div>
            </div>
            <div class="box grid-col-span-4 cross-curricular-container">
                <div class="box-label">CROSS-CURRICULAR COMPETENCES</div>
                <select id="crossCurricularSelect">
                    <option value="" selected disabled>-- Select an option --</option>
                    <option value="Intellectual competency: The learner discovers the relationship between the context, paralinguistic features, and the meaning of words, expressions and sentences.&#10;Methodological competency: The learner makes use of the context and paralinguistic features to identify the meaning of words, expressions and sentences.&#10;Communicative competency: The learner reacts to verbal and non-verbal messages to show understanding.&#10;Personal and social competency: The learner considers the context and paralinguistic features when interacting orally.">Intellectual: Discovers relationship between context...</option>
                    <option value="Intellectual competency: The learner demonstrates understanding of reading basics and the decoding strategies.&#10;Methodological competency: The learner employs reading basics and the decoding strategies to understand messages.&#10;Communicative competency: The learner communicates reading basics and the decoding strategies to peers.&#10;Personal and social competency: The learner considers reading basics and the decoding strategies to achieve others' understanding.">Intellectual: Demonstrates understanding of reading basics...</option>
                    <option value="Intellectual competency: The learner demonstrates understanding of the features of correct handwriting.&#10;Methodological competency: The learner implements the features of correct handwriting.&#10;Communicative competency: The learner achieves readability through the appropriate use of the features of correct handwriting.&#10;Personal and social competency: The learner values others' writings.">Intellectual: Demonstrates understanding of handwriting...</option>
                    <option value="Intellectual competency: The learner discovers the importance of words, chunks, and paralinguistic features used in oral interaction.&#10;Methodological competency: The learner exploits the linguistic repertoire and paralinguistic features to interact orally.&#10;Communicative competency: The learner selects the appropriate words, expressions, and paralinguistic features to interact orally.&#10;Personal and social competency: The learner considers speech acts and context when interacting.">Intellectual: Discovers importance of words/chunks...</option>
                    <option value="Intellectual competency: The learner demonstrates understanding of the writing mechanics and the relevant information to write a message.&#10;Methodological competency: The learner implements the writing mechanics and reading skills to produce or understand a message.&#10;Communicative competency: The learner communicates the writing mechanics and reading comprehension to peers.&#10;Personal and social competency: The learner publishes one's production and collaborates with peers.">Intellectual: Demonstrates understanding of writing mechanics...</option>
                    <option value="Intellectual: The learner demonstrates an understanding of reading skills, writing mechanics, and the relevant information needed to write or interpret a message.&#10;Methodological: The learner employs reading skills, context, paralinguistic features, listening skills, and writing mechanics to comprehend or produce a short message.&#10;Communicative: The learner selects and communicates appropriate words, expressions, sentences, writing mechanics, and paralinguistic features to peers.&#10;Personal and Social: The learner publishes their own production, collaborates with peers verbally and non-verbally, and considers the context and paralinguistic features when interacting orally.">Intellectual: Demonstrates understanding of reading/writing skills...</option>
                </select>
                <textarea id="crossCurricularText" placeholder="Selected competences will appear here..." class="focusable" rows="1"></textarea>
                <span class="print-only-text"></span>
            </div>
        </div>

        <div class="box">
            <div class="box-label">LESSON PROCEDURE</div>
            
            <div class="custom-table-header">
                <div class="stages">STAGES</div>
                <div class="procedure">PROCEDURE / TASKS</div>
                <div class="interaction">INTERACTION</div>
                <div class="time">TIME</div>
            </div>
            
            <div class="procedure-row">
                <div class="stages">Warmer</div>
                <div class="procedure"><textarea id="warmerProcedure" rows="1" placeholder="..." class="focusable"></textarea></div>
                <div class="interaction"><input type="text" id="warmerInteraction" placeholder="T -> Ls" class="focusable"></div>
                <div class="time"><input type="text" id="warmerTime" placeholder="5 min" class="focusable"></div>
            </div>
            
            <div class="procedure-row">
                <div class="stages">Install resources</div>
                <div class="procedure"><div id="installResourcesProcedure" class="editable-area focusable" contenteditable="true" data-placeholder="Write your main procedure here..."></div></div>
                <div class="interaction"><input type="text" id="installInteraction" placeholder="T -> Ls" class="focusable"></div>
                <div class="time"><input type="text" id="installTime" placeholder="20 min" class="focusable"></div>
            </div>
            
            <div class="procedure-row">
                <div class="stages">Assessment</div>
                <div class="procedure"><textarea id="assessmentProcedure" rows="1" placeholder="..." class="focusable"></textarea></div>
                <div class="interaction"><input type="text" id="assessmentInteraction" placeholder="L -> L" class="focusable"></div>
                <div class="time"><input type="text" id="assessmentTime" placeholder="15 min" class="focusable"></div>
            </div>
        </div>

        <div class="box">
            <div class="box-label">SELF-REFLECTION</div>
            
            <div class="reflection-header">
                <div class="what-worked">What Worked</div>
                <div class="what-hindered">What Hindered</div>
                <div class="action-points">Action Points</div>
            </div>
            
            <div class="reflection-row">
                <div class="what-worked"><textarea id="whatWorked" placeholder="..." class="focusable"></textarea></div>
                <div class="what-hindered"><textarea id="whatHindered" placeholder="..." class="focusable"></textarea></div>
                <div class="action-points"><textarea id="actionPoints" placeholder="..." class="focusable"></textarea></div>
            </div>
        </div>

        <div class="bottom-buttons no-print">
            <button onclick="window.print()">Print</button>
            <button id="saveBtn" disabled>Save to Cloud</button>
            <button onclick="downloadPage()">Download PDF</button>
            <select id="themeSelect" onchange="changeTheme(this.value)">
                <option value="default-theme">Default</option><option value="theme-blue">Blue</option><option value="theme-green">Green</option>
                <option value="theme-yellow">Yellow</option><option value="theme-pink">Pink</option><option value="theme-purple">Purple</option><option value="theme-gray">Gray</option>
            </select>
        </div>
    </div>

<script type="module">
    // --- Import Firebase Modules ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, addDoc, getDoc, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyCVtWA2FqatlTRR1gSzCTNUSFYUAbAwLW0",
        authDomain: "printelydz.firebaseapp.com",
        projectId: "printelydz",
        storageBucket: "printelydz.appspot.com",
        messagingSenderId: "49201277305",
        appId: "1:49201277305:web:df932043e4d6d986cae7a8",
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // --- DOM Elements ---
    const saveBtn = document.getElementById('saveBtn');
    const authStatusDiv = document.getElementById('authStatus');

    // --- Auth Listener ---
    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            saveBtn.disabled = false;
            authStatusDiv.innerHTML = `Logged in: <strong>${user.email}</strong>`;
            loadPlanFromSession();
        } else {
            currentUser = null;
            saveBtn.disabled = true;
            authStatusDiv.innerHTML = `Please <a href="/login.html" style="color: var(--accent-color);">log in</a> to save your work online.`;
        }
    });

    // --- Save to Firestore ---
    saveBtn.addEventListener('click', async () => {
        if (!currentUser) return alert("You must be logged in to save.");
        const planName = prompt("Please enter a name for your lesson plan:", "My Lesson Plan");
        if (!planName) return;

        try {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            const lessonPlanData = {
                planName,
                plannerType: 'final1',
                school: document.getElementById('schoolName').value,
                teacher: document.getElementById('teacherName').value,
                level: document.getElementById('levelSelect').value,
                learners: document.getElementById('learnerCount').value,
                sequence: document.getElementById('sequenceSelect').value,
                section: document.getElementById('sectionSelect').value,
                session: document.getElementById('sessionSelect').value,
                objective: document.getElementById('sessionObjective').value,
                targetCompetence: document.getElementById('targetCompetenceText').value,
                crossCurricular: document.getElementById('crossCurricularText').value,
                materials: Array.from(document.querySelectorAll('#teachingMaterials input:checked')).map(cb => cb.value),
                warmer: { procedure: document.getElementById('warmerProcedure').value, interaction: document.getElementById('warmerInteraction').value, time: document.getElementById('warmerTime').value },
                install: { procedure: document.getElementById('installResourcesProcedure').innerHTML, interaction: document.getElementById('installInteraction').value, time: document.getElementById('installTime').value },
                assessment: { procedure: document.getElementById('assessmentProcedure').value, interaction: document.getElementById('assessmentInteraction').value, time: document.getElementById('assessmentTime').value },
                reflection: { worked: document.getElementById('whatWorked').value, hindered: document.getElementById('whatHindered').value, actionPoints: document.getElementById('actionPoints').value },
                createdAt: serverTimestamp(), authorId: currentUser.uid
            };
            await addDoc(collection(db, 'users', currentUser.uid, 'lessonPlans'), lessonPlanData);
            alert(`Lesson plan "${planName}" saved successfully!`);
        } catch (error) {
            console.error("Error saving document: ", error);
            alert("There was an error saving your lesson plan.");
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save to Cloud';
        }
    });
    
    // --- Load from Session Storage ---
    async function loadPlanFromSession() {
        const planId = sessionStorage.getItem('planToLoadId');
        if (!planId || !currentUser) return;
        try {
            const docRef = doc(db, 'users', currentUser.uid, 'lessonPlans', planId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('schoolName').value = data.school || '';
                document.getElementById('teacherName').value = data.teacher || '';
                document.getElementById('levelSelect').value = data.level || '';
                document.getElementById('learnerCount').value = data.learners || '';
                document.getElementById('sessionObjective').value = data.objective || '';
                document.getElementById('targetCompetenceText').value = data.targetCompetence || '';
                document.getElementById('crossCurricularText').value = data.crossCurricular || '';
                
                if (data.materials) data.materials.forEach(val => {
                  const cb = document.querySelector(`#teachingMaterials input[value="${val}"]`);
                  if (cb) cb.checked = true;
                });

                document.getElementById('warmerProcedure').value = data.warmer?.procedure || '';
                document.getElementById('warmerInteraction').value = data.warmer?.interaction || '';
                document.getElementById('warmerTime').value = data.warmer?.time || '';
                document.getElementById('installResourcesProcedure').innerHTML = data.install?.procedure || '';
                document.getElementById('installInteraction').value = data.install?.interaction || '';
                document.getElementById('installTime').value = data.install?.time || '';
                document.getElementById('assessmentProcedure').value = data.assessment?.procedure || '';
                document.getElementById('assessmentInteraction').value = data.assessment?.interaction || '';
                document.getElementById('assessmentTime').value = data.assessment?.time || '';
                document.getElementById('whatWorked').value = data.reflection?.worked || '';
                document.getElementById('whatHindered').value = data.reflection?.hindered || '';
                document.getElementById('actionPoints').value = data.reflection?.actionPoints || '';
                
                autoResizeAllTextareas();
                
                // Update dropdown print text
                updateDropdownPrintText('levelSelect');
                updateDropdownPrintText('sequenceSelect');
                updateDropdownPrintText('sectionSelect');
                updateDropdownPrintText('sessionSelect');
                
                levelSelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                  document.getElementById('sequenceSelect').value = data.sequence || '';
                  updateDropdownPrintText('sequenceSelect');
                  sequenceSelect.dispatchEvent(new Event('change'));
                  setTimeout(() => {
                    document.getElementById('sectionSelect').value = data.section || '';
                    updateDropdownPrintText('sectionSelect');
                    sectionSelect.dispatchEvent(new Event('change'));
                    setTimeout(() => {
                      document.getElementById('sessionSelect').value = data.session || '';
                      updateDropdownPrintText('sessionSelect');
                    }, 50);
                  }, 50);
                }, 50);
            }
        } catch (error) { console.error("Error loading plan:", error); }
        finally { sessionStorage.removeItem('planToLoadId'); }
    }

    // --- Curriculum Data ---
    const curriculum = { "3PS": { "Family and Friends": { "Family": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Friends": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "School": { "School Objects": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "School Subjects": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Home": { "Describing a House": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Location Rooms in a House": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Play Time": { "Toys": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Favourite Toys": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Pets": { "Pets": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Pets Body Parts": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] }, "Birthday": { "Party Invitation": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"], "Party Celebration": ["I sing and have fun, I listen and repeat","I read and discover","I read and write","I play roles"] } }, "4PS": { "Family and Friends": { "Family": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Friends": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] }, "School": { "School Facilities": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Mapping": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] }, "Fun Time and Games": { "Fun Time": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Games": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] }, "Food and Health": { "Food": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Health": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] }, "Animals": { "Farm": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"], "Zoo": ["I sing and have fun, I listen and repeat","I read and discover","I read and enjoy","I read and write","I play roles"] } }, "5PS": { "Jobs, Occupations, and Hobbies": { "Jobs and Occupations": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Hobbies": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] }, "Hometown, City, Village Amenities": { "Amenities": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Directions": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] }, "Holidays and Travelling": { "Holidays": ["I get ready","I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","i learn to write","I write"], "Travelling": ["I listen and interact","I listen and discover","I read and understand","I read and discover","I learn and enjoy","I learn to write","I write","I check my progress"] } } };
    
    const [levelSelect, sequenceSelect, sectionSelect, sessionSelect] = ["levelSelect", "sequenceSelect", "sectionSelect", "sessionSelect"].map(id => document.getElementById(id));
    levelSelect.addEventListener("change", () => {
        sequenceSelect.innerHTML = "<option value=''>-- Select --</option>"; sectionSelect.innerHTML = "<option value=''>-- Select --</option>"; sessionSelect.innerHTML = "<option value=''>-- Select --</option>";
        if (curriculum[levelSelect.value]) {
            Object.keys(curriculum[levelSelect.value]).forEach(seq => sequenceSelect.add(new Option(seq, seq)));
            sequenceSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
        }
        updateDropdownPrintText('levelSelect');
    });
    sequenceSelect.addEventListener("change", () => {
        sectionSelect.innerHTML = "<option value=''>-- Select --</option>"; sessionSelect.innerHTML = "<option value=''>-- Select --</option>";
        if (sequenceSelect.value === "Remediation & Standardisation") return sectionSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
        const seqData = curriculum[levelSelect.value]?.[sequenceSelect.value];
        if (seqData) Object.keys(seqData).forEach(sec => sectionSelect.add(new Option(sec, sec)));
        updateDropdownPrintText('sequenceSelect');
    });
    sectionSelect.addEventListener("change", () => {
        sessionSelect.innerHTML = "<option value=''>-- Select --</option>";
        if (sectionSelect.value === "Remediation & Standardisation") return sessionSelect.add(new Option("Remediation & Standardisation", "Remediation & Standardisation"));
        const sessData = curriculum[levelSelect.value]?.[sequenceSelect.value]?.[sectionSelect.value];
        if (sessData) sessData.forEach(ses => sessionSelect.add(new Option(ses, ses)));
        updateDropdownPrintText('sectionSelect');
    });
    sessionSelect.addEventListener("change", () => {
        updateDropdownPrintText('sessionSelect');
    });

    // --- Auto-resize and Competence Logic ---
    function autoResize(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
    function autoResizeAllTextareas() { document.querySelectorAll('textarea').forEach(autoResize); }
    document.querySelectorAll('textarea').forEach(el => el.addEventListener('input', () => autoResize(el)));
    
    document.getElementById('targetCompetenceSelect').addEventListener('change', (e) => { 
        const targetText = document.getElementById('targetCompetenceText');
        targetText.value = e.target.value; 
        autoResize(targetText);
        
        // Update print-only text with FULL value
        const printText = document.querySelector('.target-competence-container .print-only-text');
        if (printText) {
            printText.textContent = e.target.value.replace(/&#10;/g, '\n');
        }
    });
    document.getElementById('crossCurricularSelect').addEventListener('change', (e) => { 
        const crossText = document.getElementById('crossCurricularText');
        crossText.value = e.target.value.replace(/&#10;/g, '\n'); 
        autoResize(crossText);
        
        // Update print-only text with FULL value
        const printText = document.querySelector('.cross-curricular-container .print-only-text');
        if (printText) {
            printText.textContent = e.target.value.replace(/&#10;/g, '\n');
        }
    });

    // --- Page Functions ---
window.downloadPage = () => {
  window.print();
};
    window.changeTheme = theme => { document.body.className = theme; localStorage.setItem("lessonTheme", theme); };

    // --- Image Upload Functionality ---
    let currentImageFile = null;
    
    document.getElementById('insertImageBtn').addEventListener('click', () => {
        document.getElementById('imageUpload').click();
    });
    
    document.getElementById('imageUpload').addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            if (file.type.startsWith('image/')) {
                currentImageFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('previewImg').src = event.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please select a valid image file.');
            }
        }
    });
    
    document.getElementById('confirmImage').addEventListener('click', () => {
        if (currentImageFile) {
            const editableArea = document.getElementById('installResourcesProcedure');
            editableArea.focus();
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                    
                    // Move cursor after the image
                    range.setStartAfter(img);
                    range.setEndAfter(img);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    editableArea.appendChild(img);
                }
                
                // Hide preview
                document.getElementById('imagePreview').style.display = 'none';
                currentImageFile = null;
            };
            reader.readAsDataURL(currentImageFile);
        }
    });
    
    document.getElementById('cancelImage').addEventListener('click', () => {
        document.getElementById('imagePreview').style.display = 'none';
        currentImageFile = null;
    });
    
    // Close preview when clicking outside
    document.addEventListener('click', (e) => {
        const preview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('insertImageBtn');
        
        if (preview.style.display === 'block' && 
            !preview.contains(e.target) && 
            e.target !== uploadBtn) {
            preview.style.display = 'none';
            currentImageFile = null;
        }
    });

    // --- Update Dropdown Print Text ---
    function updateDropdownPrintText(selectId) {
        const select = document.getElementById(selectId);
        const container = select.closest('.dropdown-text-container');
        const printText = container.querySelector('.dropdown-print-text');
        
        if (printText) {
            printText.textContent = select.value || '';
        }
    }

    // --- On Load ---
    window.addEventListener('load', () => {
        const saved = localStorage.getItem("lessonTheme");
        if (saved) { document.body.className = saved; document.getElementById("themeSelect").value = saved; }
        autoResizeAllTextareas();
        setupPrinting();
        setupRibbonControls();
        
        // Initialize dropdown print text
        updateDropdownPrintText('levelSelect');
        updateDropdownPrintText('sequenceSelect');
        updateDropdownPrintText('sectionSelect');
        updateDropdownPrintText('sessionSelect');
    });

    // --- Setup Ribbon Controls ---
    function setupRibbonControls() {
        // Command buttons
        document.querySelectorAll('#ribbon-toolbar button[data-command]').forEach(button => {
            button.addEventListener('click', () => {
                const command = button.getAttribute('data-command');
                if (command === 'createLink') {
                    const url = prompt('Enter the link URL:');
                    if (url) document.execCommand(command, false, url);
                } else {
                    document.execCommand(command, false, null);
                }
                // Update active state for formatting buttons
                updateActiveState();
            });
        });

        // Font size
        document.getElementById('fontSize').addEventListener('change', function() {
            document.execCommand('fontSize', false, this.value);
        });

        // Font color
        document.getElementById('fontColor').addEventListener('change', function() {
            document.execCommand('foreColor', false, this.value);
        });

        // Update active state for buttons
        function updateActiveState() {
            const commands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertUnorderedList', 'insertOrderedList'];
            commands.forEach(command => {
                const button = document.querySelector(`#ribbon-toolbar button[data-command="${command}"]`);
                if (button) {
                    if (document.queryCommandState(command)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }

        // Initial update
        updateActiveState();

        // Update on selection change
        document.addEventListener('selectionchange', updateActiveState);
    }

    // --- Setup Printing ---
    function setupPrinting() {
        // This function is called on load to handle any print-specific setup
        // The ribbon is already hidden during print via the .no-print class
    }
</script>
</body>
</html>